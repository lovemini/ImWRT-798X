name: ImmortalWrt-24.10-6.6固件构建

on:
  repository_dispatch:
    types: [build_firmware]
  workflow_dispatch:
    inputs:
      device_model:
        description: '选择目标设备型号'
        type: choice
        required: true
        options:
          - 中国移动 RAX3000M NAND
          - 中国移动 RAX3000M eMMC
          - Cudy AP3000 AX3000
          - Cudy AP3000 户外版
          - Cudy M3000 AX3000
          - Cudy RE3000 AX3000 中继器
          - Cudy TR3000 AX3000
          - Cudy TR3000 AX3000 256MB
          - Cudy WR3000 AX3000
          - Cudy WR3000S AX3000 增强版
          - GL.iNet Mango AX MT2500
          - GL.iNet Beryl AX MT3000
          - GL.iNet X3000 LTE
          - GL.iNet XE3000 工业级 LTE
          - H3C NX30 Pro 魔术路由器
          - 华思飞 WH3000 Pro
          - 华思飞 WH3000 eMMC
          - JCG Q30 Pro AX3000
          - Livinet ZR3020 AX3000
          - Routerich AX3000
          - Routerich AX3000 V1
          - 小米 AX3000T
          - 小米 WR30U 原厂
          - 红米 AX6000 原厂
          - 合勤 EX5601-T0 原厂
          - 合勤 NWA50AX Pro AP

      enable_5g_25db:
        description: '启用5G 25dB修改'
        type: boolean
        required: true
        default: true
      repo_url:
        description: '源代码仓库URL'
        default: 'https://github.com/padavanonly/immortalwrt-mt798x-24.10'
      repo_branch:
        description: '源代码仓库分支'
        default: 'openwrt-24.10-6.6'
  schedule:
    - cron: '0 7 * * 5'  # 每周五07:00 UTC（北京时间15:00）

permissions:
  contents: write
  actions: write

env:
  REPO_URL: ${{ github.event.inputs.repo_url || 'https://github.com/padavanonly/immortalwrt-mt798x-24.10' }}
  REPO_BRANCH: ${{ github.event.inputs.repo_branch || 'openwrt-24.10-6.6' }}
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: 24.10-6.6.config
  DIY_P1_SH: scripts/diy-part1.sh
  DIY_P2_SH: scripts/diy-part2.sh
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai
  WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
  WEBDAV_USERNAME: ${{ secrets.WEBDAV_USERNAME }}
  WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
  ENABLE_5G_25DB: ${{ github.event.inputs.enable_5g_25db != 'false' }} # 默认为 true

jobs:
  check-source-updates:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
    steps:
      - name: 检出配置仓库
        uses: actions/checkout@v4

      - name: 检查源代码更新
        id: check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 只有定时任务才需要检查更新，手动触发直接构建
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] || [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            echo "手动触发，跳过更新检查。"
            echo "should_build=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          LATEST_SHA=$(gh api repos/padavanonly/immortalwrt-mt798x-24.10/commits/$REPO_BRANCH --jq '.sha' || echo "")
          if [ -z "$LATEST_SHA" ]; then
            echo "should_build=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # 尝试下载上次的SHA artifact，如果不存在则视为新构建
          if ! gh run download -n last-checked-sha 2>/dev/null; then
             echo "首次运行或Artifact过期"
             LAST_CHECKED_SHA=""
          else
             LAST_CHECKED_SHA=$(cat last_checked_sha.txt)
          fi

          if [ "$LATEST_SHA" != "$LAST_CHECKED_SHA" ]; then
            echo "检测到更新: $LATEST_SHA"
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "$LATEST_SHA" > last_checked_sha.txt
          else
            echo "无更新"
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi

      - name: 保存新的SHA
        if: steps.check.outputs.should_build == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: last-checked-sha
          path: last_checked_sha.txt
          retention-days: 7

  build:
    needs: check-source-updates
    if: needs.check-source-updates.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # 如果是手动触发，只构建选中的型号；如果是定时任务，构建列表中的所有型号
        device_model: ${{ github.event_name == 'workflow_dispatch' && fromJSON(format('["{0}"]', github.event.inputs.device_model)) || fromJSON('["cmcc_rax3000m", "cmcc_rax3000m-emmc", "cudy_ap3000-v1", "cudy_ap3000outdoor-v1", "cudy_m3000-v1", "cudy_re3000-v1", "cudy_tr3000-v1", "cudy_tr3000-v1-256mb", "cudy_wr3000-v1", "cudy_wr3000s-v1", "glinet_gl-mt2500", "glinet_gl-mt3000", "glinet_gl-x3000", "glinet_gl-xe3000", "h3c_magic-nx30-pro", "huasifei_wh3000-pro", "huasifei_wh3000-emmc", "jcg_q30-pro", "livinet_zr-3020", "routerich_ax3000", "routerich_ax3000-v1", "xiaomi_mi-router-ax3000t", "xiaomi_mi-router-wr30u-stock", "xiaomi_redmi-router-ax6000-stock", "zyxel_ex5601-t0-stock", "zyxel_nwa50ax-pro"]') }}
    steps:
      - name: 检出仓库
        uses: actions/checkout@v4

      - name: 解析设备型号 (Python)
        id: determine_model
        env:
          INPUT_MODEL: ${{ matrix.device_model }}
          IS_MANUAL: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          python3 -c '
          import os
          
          # 定义映射字典： "显示名称": "内部代码"
          # 如果输入已经是内部代码(定时任务)，则代码和名称相同或查表反推
          mapping = {
              "中国移动 RAX3000M NAND": "cmcc_rax3000m",
              "中国移动 RAX3000M eMMC": "cmcc_rax3000m-emmc",
              "Cudy AP3000 AX3000": "cudy_ap3000-v1",
              "Cudy AP3000 户外版": "cudy_ap3000outdoor-v1",
              "Cudy M3000 AX3000": "cudy_m3000-v1",
              "Cudy RE3000 AX3000 中继器": "cudy_re3000-v1",
              "Cudy TR3000 AX3000": "cudy_tr3000-v1",
              "Cudy TR3000 AX3000 256MB": "cudy_tr3000-v1-256mb",
              "Cudy WR3000 AX3000": "cudy_wr3000-v1",
              "Cudy WR3000S AX3000 增强版": "cudy_wr3000s-v1",
              "GL.iNet Mango AX MT2500": "glinet_gl-mt2500",
              "GL.iNet Beryl AX MT3000": "glinet_gl-mt3000",
              "GL.iNet X3000 LTE": "glinet_gl-x3000",
              "GL.iNet XE3000 工业级 LTE": "glinet_gl-xe3000",
              "H3C NX30 Pro 魔术路由器": "h3c_magic-nx30-pro",
              "华思飞 WH3000 Pro": "huasifei_wh3000-pro",
              "华思飞 WH3000 eMMC": "huasifei_wh3000-emmc",
              "JCG Q30 Pro AX3000": "jcg_q30-pro",
              "Livinet ZR3020 AX3000": "livinet_zr-3020",
              "Routerich AX3000": "routerich_ax3000",
              "Routerich AX3000 V1": "routerich_ax3000-v1",
              "小米 AX3000T": "xiaomi_mi-router-ax3000t",
              "小米 WR30U 原厂": "xiaomi_mi-router-wr30u-stock",
              "红米 AX6000 原厂": "xiaomi_redmi-router-ax6000-stock",
              "合勤 EX5601-T0 原厂": "zyxel_ex5601-t0-stock",
              "合勤 NWA50AX Pro AP": "zyxel_nwa50ax-pro"
          }

          input_model = os.environ.get("INPUT_MODEL")
          is_manual = os.environ.get("IS_MANUAL") == "true"
          
          device_code = ""
          display_name = ""

          if is_manual:
              # 手动触发：输入是"显示名称"，查表得"内部代码"
              display_name = input_model
              device_code = mapping.get(input_model, "unknown")
          else:
              # 自动触发：输入是"内部代码"，反查"显示名称"
              device_code = input_model
              # 反转字典查找
              rev_mapping = {v: k for k, v in mapping.items()}
              display_name = rev_mapping.get(input_model, input_model)

          if device_code == "unknown":
              print(f"Error: Unknown model {input_model}")
              exit(1)

          print(f"Device Code: {device_code}")
          print(f"Display Name: {display_name}")
          
          # 写入 GitHub Output 和 Env
          with open(os.environ["GITHUB_ENV"], "a") as f:
              f.write(f"device_code={device_code}\n")
              f.write(f"display_name={display_name}\n")
          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"actual_device_model={device_code}\n")
          '

      - name: 清理磁盘空间
        uses: docker://ghcr.io/check-disk-space/action:v1.0.3
        with:
          # 释放大量空间，移除安卓SDK、dotnet等
          remove_android: true
          remove_dotnet: true
          remove_haskell: true
          remove_codeql: true
          remove_docker_images: true

      - name: 初始化编译环境
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install -y build-essential ccache git gawk gcc-multilib g++-multilib \
            libelf-dev libncurses5-dev libncursesw5-dev libssl-dev python3 python3-pip \
            python3-ply python3-pyelftools rsync unzip zlib1g-dev squashfs-tools \
            device-tree-compiler binutils bison flex
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "$TZ"
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir

      - name: 配置 ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ env.device_code }}-${{ env.REPO_BRANCH }}
          max-size: 2G

      - name: 克隆源代码
        working-directory: /workdir
        run: |
          git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt
          ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

      - name: 缓存下载库 (DL)
        uses: actions/cache@v4
        with:
          path: /workdir/openwrt/dl
          key: ${{ runner.os }}-openwrt-dl-${{ hashFiles('openwrt/include/kernel*') }}
          restore-keys: |
            ${{ runner.os }}-openwrt-dl-

      - name: 加载并更新 Feeds
        run: |
          [ -e $FEEDS_CONF ] && mv $FEEDS_CONF openwrt/feeds.conf.default
          chmod +x $DIY_P1_SH $DIY_P2_SH
          cd openwrt
          $GITHUB_WORKSPACE/$DIY_P1_SH
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: 生成配置
        run: |
          [ -e files ] && mv files openwrt/files
          [ -e $CONFIG_FILE ] && mv $CONFIG_FILE openwrt/.config
          
          cd openwrt
          # 追加目标设备配置
          echo "CONFIG_TARGET_mediatek_filogic_DEVICE_${{ env.device_code }}=y" >> .config
          
          # 执行自定义脚本
          $GITHUB_WORKSPACE/$DIY_P2_SH
          
          # 生成完整配置
          make defconfig

      - name: 下载软件包
        working-directory: ./openwrt
        run: |
          make download -j8
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;

      - name: 修改无线功率 (5G 25dB)
        if: env.ENABLE_5G_25DB == 'true'
        working-directory: ./openwrt
        run: |
          EEPROM_FILE="package/mtk/drivers/mt_wifi/files/mt7981-default-eeprom/MT7981_iPAiLNA_EEPROM.bin"
          echo "正在检查 EEPROM 文件: $EEPROM_FILE"
          
          if [ -f "$EEPROM_FILE" ]; then
             # 使用 python 进行更安全的二进制修改，避免 dd 魔法数字难以阅读
             python3 -c "
          path = '$EEPROM_FILE'
          offset = 0x445
          length = 20
          new_bytes = b'\x2B' * length # 0x2B = 43 (十进制)，对应功率设置
          
          try:
              with open(path, 'r+b') as f:
                  f.seek(offset)
                  current = f.read(length)
                  if current != new_bytes:
                      f.seek(offset)
                      f.write(new_bytes)
                      print(f'Successfully patched {length} bytes at offset {hex(offset)}')
                  else:
                      print('Patch already applied.')
          except Exception as e:
              print(f'Error patching file: {e}')
              exit(1)
             "
          else
             echo "警告: 未找到 EEPROM 文件，跳过修改。"
          fi

      - name: 编译固件
        id: compile
        working-directory: ./openwrt
        run: |
          echo -e "$(nproc) thread compile"
          make -j$(nproc) || make -j1 V=s
          echo "status=success" >> $GITHUB_OUTPUT

      - name: 提取版本与整理文件
        id: organize
        if: steps.compile.outputs.status == 'success'
        working-directory: ./openwrt
        run: |
          # 提取版本号逻辑简化
          VERSION=""
          # 尝试从 base-files 获取
          if [ -f "package/base-files/files/etc/openwrt_release" ]; then
             VERSION=$(grep DISTRIB_REVISION package/base-files/files/etc/openwrt_release | awk -F "'" '{print $2}')
          fi
          # 回退到 git tag
          if [ -z "$VERSION" ]; then
             VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "R$(date +%Y.%m.%d)")
          fi
          
          echo "FIRMWARE_VERSION=$VERSION" >> $GITHUB_ENV
          echo "FIRMWARE_PATH=$PWD/bin/targets" >> $GITHUB_ENV
          
          cd bin/targets/*/*
          rm -rf packages
          
          # 重命名文件
          for file in *sysupgrade* *factory*; do
            if [ -f "$file" ] && ! echo "$file" | grep -q "-bl2"; then
              EXT="${file##*.}"
              TYPE=$(echo "$file" | grep -o "sysupgrade\|factory")
              # 统一命名格式
              mv "$file" "${{ env.device_code }}_25dB_${VERSION}_${TYPE}.${EXT}"
            fi
          done
          echo "status=success" >> $GITHUB_OUTPUT

      - name: 生成发布说明
        if: steps.organize.outputs.status == 'success'
        run: |
          cat << EOF > RELEASE.txt
          # ImmortalWrt 固件发布
          
          **设备**: ${{ env.display_name }}
          **版本**: ${{ env.FIRMWARE_VERSION }}
          **构建时间**: $(date +"%Y-%m-%d %H:%M")
          **特性**: 5G 25dB 增强版
          
          ## 注意事项
          * 默认管理IP: 192.168.1.1 (或根据源码设定)
          * 用户名: root / 密码: (空)
          * 请根据需要选择 sysupgrade (升级) 或 factory (重刷) 包。
          EOF

      - name: 发布至 GitHub Releases
        uses: softprops/action-gh-release@v2
        if: env.UPLOAD_RELEASE == 'true' && steps.organize.outputs.status == 'success'
        with:
          tag_name: ImmortalWrt-${{ env.FIRMWARE_VERSION }}-${{ env.device_code }}
          body_path: RELEASE.txt
          files: ${{ env.FIRMWARE_PATH }}/*/*/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 上传至 WebDAV
        if: env.WEBDAV_URL && env.WEBDAV_USERNAME && env.WEBDAV_PASSWORD && steps.organize.outputs.status == 'success'
        run: |
          find ${{ env.FIRMWARE_PATH }} -type f \( -name "*sysupgrade*" -o -name "*factory*" \) | while read FILE; do
            FILENAME=$(basename "$FILE")
            echo "Uploading $FILENAME..."
            curl -u "${{ env.WEBDAV_USERNAME }}:${{ env.WEBDAV_PASSWORD }}" \
              -T "$FILE" \
              "${{ env.WEBDAV_URL }}/$FILENAME" --create-dirs
          done

      - name: 清理旧工作流
        uses: Mattraks/delete-workflow-runs@v2
        with:
          retain_days: 7
          keep_minimum_runs: 3
